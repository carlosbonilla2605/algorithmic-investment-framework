# Copilot Project Wiki for Algorithmic Investment Framework

## Quick links
- Project vision: `docs/PROJECT_VISION.md`
- Readme: `README.md`
- Quick start script: `quick_start.py`
- Example runner: `run_example.py`
- Development manifesto: `docs/LLM_ASSISTED_DEVELOPMENT_MANIFESTO.md`
- Product backlog: `PRODUCT_BACKLOG.md`

## Project structure and execution

### Running the dashboard (preferred)
Always launch Streamlit using the project’s virtual environment Python and the `-m` flag:
```bash
python -m streamlit run dashboards/main_dashboard.py
```

Notes:
- Activate your virtual environment first (see below)
- The entry point is `dashboards/main_dashboard.py`
- Using `-m streamlit` avoids PATH issues and ImportErrors

### Environment setup (macOS, zsh)
```bash
# create venv (first time)
python3 -m venv venv

# activate
source venv/bin/activate

# upgrade pip and install deps
python -m pip install --upgrade pip
pip install -r requirements.txt

# run dashboard (from the same venv)
python -m streamlit run dashboards/main_dashboard.py
```

### Project organization
```
algorithmic-investment-framework/
├── .venv/                    # Virtual environment (use this Python!)
├── dashboards/              # Streamlit dashboards (entry point)
├── src/                     # Core framework code
│   ├── analysis/           # Analysis and ranking logic
│   ├── data_acquisition/   # Market data and news fetching
│   ├── database/          # Database operations
│   └── trading/           # Trading execution
├── tests/                  # Test suite
└── data/                   # Data storage (including SQLite DB)
```

### Troubleshooting
- Streamlit exits with code 127 or “command not found”:
  - Use `python -m streamlit ...` from the venv instead of `streamlit ...`
  - Ensure venv is active: `source .venv/bin/activate`
  - Verify install: `python -m pip show streamlit`
- Dashboard can’t find modules:
  - Run from repo root and use `-m streamlit` as above
  - Confirm `src` is on PYTHONPATH (Streamlit run from root handles this)

### Common tasks
- Run ranking engine once: `python src/main.py`
- View latest log: open `logs/framework.log`

## LLM operating procedure (must read before edits)

Read in this order before proposing code changes:
1. `README.md` – overview, run commands, conventions
2. `.copilot_wiki.md` – setup/runbook/troubleshooting (this file)
3. `docs/PROJECT_VISION.md` – original scope and goals
4. `SETUP_GUIDE.md`, `env_example.txt` – environment, secrets
5. `requirements.txt`, `setup.py` – dependencies and packaging
6. `config/default_config.py` – configuration flags and defaults
7. Entrypoints: `src/main.py`, `dashboards/main_dashboard.py`
8. Database layer: `src/database/models.py`, `src/database/database_manager.py`
9. Analysis: `src/analysis/ranking_engine.py`
10. Data acquisition: `src/data_acquisition/market_data.py`, `src/data_acquisition/news_sentiment.py`
11. Trading: `src/trading/alpaca_client.py`, `src/trading/risk_manager.py`
12. Tests: `tests/test_integration.py`

Safeguards and conventions:
- Keep read-paths returning dicts; never return ORM rows post-session.
- Coerce dates safely; convert Decimal→float for UI/JSON.
- Add guards for missing API keys; do not enable live trading by default.
- Prefer small, targeted diffs; avoid mass reformatting.
- Update README/wiki for public behavior or setup changes.
- Launch Streamlit via `python -m streamlit ...` from the venv.

Quality gates checklist:
- Syntax/lint: no errors introduced.
- Tests: run integration test; add/adjust tests for behavior changes.
- Smoke: run ranking engine and open dashboard without crashes.
- Docs: confirm references and instructions are current.

## Database schema and relationships

### Core Tables

#### Securities (`securities`)
- Primary Key: `id` (Integer)
- Key Fields:
  - `symbol` (String, unique, indexed)
  - `name` (String)
  - `is_active` (Boolean)
- Relationships:
  - Has many: price_data, rankings, trades
  - Many-to-many with news_articles through security_news_link

#### Price Data (`price_data`)
- Primary Key: `id` (Integer)
- Key Fields:
  - `security_id` (Foreign Key → securities)
  - `date` (DateTime, indexed)
  - `close_price` (Decimal)
  - `volume` (BigInteger)
- Indexes: 
  - Composite (security_id, date)
- Relationships:
  - Belongs to: security

#### News Articles (`news_articles`)
- Primary Key: `id` (Integer)
- Key Fields:
  - `headline` (Text)
  - `published_at` (DateTime, indexed)
- Relationships:
  - Many-to-many with securities through security_news_link
  - Has many: article_sentiments

#### Article Sentiments (`article_sentiments`)
- Primary Key: `id` (Integer)
- Key Fields:
  - `article_id` (Foreign Key → news_articles)
  - `sentiment_model` (String)
  - `compound_score` (Float)
- Relationships:
  - Belongs to: news_article

#### Ranking Results (`ranking_results`)
- Primary Key: `id` (Integer)
- Key Fields:
  - `security_id` (Foreign Key → securities)
  - `analysis_date` (DateTime, indexed)
  - `composite_score` (Float)
  - `technical_score` (Float)
  - `sentiment_score` (Float)
- Indexes:
  - Composite (analysis_date, rank)
  - Composite (security_id, analysis_date)
- Relationships:
  - Belongs to: security

### Important Queries

#### Getting Latest Rankings
```sql
SELECT r.*, s.symbol, p.close_price 
FROM ranking_results r
JOIN securities s ON r.security_id = s.id
JOIN price_data p ON s.id = p.security_id 
  AND r.analysis_date = p.date
WHERE r.analysis_date = (
  SELECT MAX(analysis_date) FROM ranking_results
)
```

#### Getting Latest News with Sentiment
```sql
SELECT n.*, a.compound_score
FROM news_articles n
JOIN article_sentiments a ON n.id = a.article_id
JOIN security_news_link snl ON n.id = snl.article_id
JOIN securities s ON snl.security_id = s.id
WHERE s.symbol = ? AND n.published_at >= ?
ORDER BY n.published_at DESC
```

## Recent fixes and changes
1. Fixed database initialization in `models.py` (connection.commit issue)
2. Updated session handling in `database_manager.py`
3. Fixed session parameter passing in `ranking_engine.py`

## Debugging tools
Created `debug_db.py` for testing database operations in isolation.

---
Last Updated: 2025-08-10 (made visible in Git, added quick links, setup, and troubleshooting)
